
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Digital Twin Demo - Madeeha Nayeem</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
  :root{--bg:#0b1220;--panel:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--accent:#22d3ee;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;}
  html,body{height:100%;margin:0;background:#0b1220;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:14px}
  h1{margin:.2rem 0 1rem;font-size:clamp(22px,3.6vw,38px)}
  model-viewer{width:100%;height:min(60vh,520px);background:linear-gradient(180deg,#050a16,#0b1220)}
  .row{display:grid;grid-template-columns:1fr 130px;gap:12px;align-items:center}
  input[type=range]{width:100%}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
  @media(max-width:900px){.kpi{grid-template-columns:repeat(2,1fr)}}
  .box{background:#0b1324;border:1px solid #1f2937;border-radius:12px;padding:10px}
  .big{font-size:22px;font-weight:700}
  .tiny{font-size:12px;color:#94a3b8}
  .wfwrap{position:relative}
  canvas{display:block;width:100%;height:260px;background:#050a16;border:1px solid #1f2937;border-radius:12px}
  .ylabel{position:absolute;left:6px;transform:translateY(50%);font-size:11px;color:#94a3b8;background:transparent}
  .label-0{bottom:8px}
  .label-50{bottom:calc(8px + 25% - 7px)}
  .label-100{bottom:calc(8px + 50% - 7px)}
  .label-150{bottom:calc(8px + 75% - 7px)}
  .label-200{top:8px}
</style>
</head>
<body>
<div class="wrap">



  <h1>Digital Twin Demo - Madeeha Nayeem</h1>

<p class="intro">
  This demo shows a simplified <strong>digital twin of the cardiovascular system</strong>.
  <br><br>
  Use the sliders to change heart rate, contractility, resistance, and compliance.  
  Check the medication boxes to simulate common drug effects.  
  The graph updates in real time to show the <em>arterial pressure waveform</em> 
  and outputs such as cardiac output (CO), mean arterial pressure (MAP), 
  and systolic/diastolic values.  
  <br><br>
  This is not a medical device — it’s an educational prototype to demonstrate 
  how <strong>digital twins + interactive models</strong> can support cardiovascular care.
</p>

  <div class="grid">
    <section class="card">
      <h2>Digital Heart</h2>
      <model-viewer id="mv" src="realistic_human_heart.glb"  camera-controls auto-rotate shadow-intensity="1" exposure="1.1"></model-viewer>
    </section>

    <section class="card">
      <h2>Twin Inputs & Meds</h2>
      <div class="row"><div>Heart Rate (bpm): <strong id="hrVal">70</strong></div><input id="hr" type="range" min="40" max="160" value="70" step="1"></div>
      <div class="row"><div>Contractility: <strong id="inoVal">1.00×</strong></div><input id="ino" type="range" min="0.6" max="1.6" value="1.0" step="0.01"></div>
      <div class="row"><div>Resistance (TPR): <strong id="resVal">1.00×</strong></div><input id="res" type="range" min="0.5" max="1.8" value="1.0" step="0.01"></div>
      <div class="row"><div>Compliance: <strong id="compVal">1.00×</strong></div><input id="comp" type="range" min="0.5" max="1.5" value="1.0" step="0.01"></div>
      <label><input id="bb" type="checkbox"> β-Blocker</label>
      <label><input id="ace" type="checkbox"> ACEi/ARB</label>
      <label><input id="diu" type="checkbox"> Diuretic</label>

      <div class="kpi">
        <div class="box"><div class="tiny">CO</div><div class="big" id="coOut">—</div><div class="tiny">L/min</div></div>
        <div class="box"><div class="tiny">MAP</div><div class="big" id="mapOut">—</div><div class="tiny">mmHg</div></div>
        <div class="box"><div class="tiny">SBP/DBP</div><div class="big" id="bpOut">— / —</div><div class="tiny">mmHg</div></div>
        <div class="box"><div class="tiny">Pulse Pressure</div><div class="big" id="ppOut">—</div><div class="tiny">mmHg</div></div>
      </div>

      <div class="wfwrap" style="margin-top:10px">
        <canvas id="press"></canvas>
        <div class="ylabel label-200">200</div>
        <div class="ylabel label-150">150</div>
        <div class="ylabel label-100">100</div>
        <div class="ylabel label-50">50</div>
        <div class="ylabel label-0">0</div>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const mv=$('mv'), swapModelBtn=$('swapModel');
  const hr=$('hr'), ino=$('ino'), res=$('res'), comp=$('comp');
  const bb=$('bb'), ace=$('ace'), diu=$('diu');
  const hrVal=$('hrVal'), inoVal=$('inoVal'), resVal=$('resVal'), compVal=$('compVal');
  const coOut=$('coOut'), mapOut=$('mapOut'), bpOut=$('bpOut'), ppOut=$('ppOut');
  const canvas=$('press'); const ctx=canvas.getContext('2d'); let W,H;

  function resize(){const dpr=window.devicePixelRatio||1;W=canvas.clientWidth*dpr;H=canvas.clientHeight*dpr;canvas.width=W;canvas.height=H;}
  window.addEventListener('resize',()=>scheduleUpdate(),{passive:true}); resize();

  const params={ SV0:70, R0:1100.0, C0:0.0017, Pd:55 };

  function applyMeds(){
    let HR=+hr.value, INO=+ino.value, Rmult=+res.value, Cmult=+comp.value, preload=1.0;
    if(bb.checked){HR*=0.85; INO*=0.90;}
    if(ace.checked){Rmult*=0.80; Cmult*=1.15;}
    if(diu.checked){preload*=0.92;}
    return {HR, INO, Rmult, Cmult, preload};
  }

  function simulate(sec=4){
    const {HR, INO, Rmult, Cmult, preload}=applyMeds();
    const dt=1/600, steps=Math.floor(sec/dt), T=60/HR;
    const SV=params.SV0*INO*preload;   
    const SV_L=SV/1000;                
    const C=params.C0*Cmult;           
    const R=params.R0*Rmult;           
    const ejT=Math.max(0.18, T*0.33);
    let P=80; const Pseries=new Float32Array(steps); let t=0,last=0;
    const A = SV_L * Math.PI / (2*ejT);
    function Qin_profile(phase){ if(phase<0||phase>=ejT) return 0; const x=phase/ejT; return A*Math.sin(Math.PI*x); }
    for(let i=0;i<steps;i++,t+=dt){
      if(t-last>=T){last=t;}
      const phase=t-last;
      const Qin=Qin_profile(phase);             
      const dPdt=(Qin - (P/R)) / Math.max(1e-6, C); 
      P += dPdt * dt;
      if(P < params.Pd*0.6) P = params.Pd*0.6;
      Pseries[i]=P;
    }
    const tail=Math.min(Math.floor(2/dt), steps-1); let Pmax=-1e9,Pmin=1e9,Psum=0;
    for(let i=steps-tail;i<steps;i++){const p=Pseries[i]; if(p>Pmax)Pmax=p; if(p<Pmin)Pmin=p; Psum+=p;}
    const MAP=Psum/tail, SBP=Pmax, DBP=Pmin, PP=SBP-DBP, CO=SV_L*HR;
    return {Pseries, dt, CO, MAP, SBP, DBP, PP};
  }

  function draw(Ps, MAP){
    ctx.clearRect(0,0,W,H);
    const pad=10, yMin=0, yMax=200;
    const yScale=(H-2*pad)/(yMax-yMin);
    const toY = (p)=> H - pad - (p - yMin) * yScale;

    ctx.fillStyle='rgba(239,68,68,0.10)'; ctx.fillRect(0,toY(60),W,toY(0)-toY(60));
    ctx.fillStyle='rgba(34,197,94,0.06)'; ctx.fillRect(0,toY(120),W,toY(60)-toY(120));
    ctx.fillStyle='rgba(245,158,11,0.08)'; ctx.fillRect(0,toY(200),W,toY(120)-toY(200));

    ctx.strokeStyle='rgba(148,163,184,0.28)'; ctx.lineWidth=1; ctx.beginPath();
    [0,50,100,150,200].forEach(v=>{const y=toY(v); ctx.moveTo(0,y); ctx.lineTo(W,y);}); ctx.stroke();

    ctx.strokeStyle='rgba(147,197,253,0.8)'; ctx.setLineDash([4,4]); ctx.beginPath();
    const yMAP=toY(MAP); ctx.moveTo(0,yMAP); ctx.lineTo(W,yMAP); ctx.stroke(); ctx.setLineDash([]);

    ctx.lineWidth=2; ctx.strokeStyle='#22d3ee'; ctx.beginPath();
    const n=Ps.length, dx=W/n;
    for(let i=0;i<n;i++){const x=i*dx; const y=toY(Ps[i]); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke();
  }

  function fmt(n,d=0){return (Math.round(n*Math.pow(10,d))/Math.pow(10,d)).toFixed(d);}

  let _pending=false;
  function doUpdate(){
    hrVal.textContent=hr.value; inoVal.textContent=(+ino.value).toFixed(2)+'×'; resVal.textContent=(+res.value).toFixed(2)+'×'; compVal.textContent=(+comp.value).toFixed(2)+'×';
    resize();
    const s=simulate(4);
    draw(s.Pseries,s.MAP);
    coOut.textContent=fmt(s.CO,2); mapOut.textContent=fmt(s.MAP,0); bpOut.textContent=fmt(s.SBP,0)+' / '+fmt(s.DBP,0); ppOut.textContent=fmt(s.PP,0);
  }
  function scheduleUpdate(){
    if(_pending) return;
    _pending=true;
    requestAnimationFrame(()=>{ _pending=false; doUpdate(); });
  }

  ['input','change'].forEach(ev=>[hr,ino,res,comp,bb,ace,diu].forEach(el=>el.addEventListener(ev, scheduleUpdate, {passive:true})));
  swapModelBtn.addEventListener('click',e=>{e.preventDefault();const url=prompt("Paste a GLB URL");if(url){mv.src=url; scheduleUpdate();}});

  function safeUpdate() {
    if (!canvas || canvas.clientWidth === 0 || canvas.clientHeight === 0) {
      requestAnimationFrame(safeUpdate);
      return;
    }
    scheduleUpdate();
  }
  document.addEventListener('DOMContentLoaded', () => requestAnimationFrame(safeUpdate));
  window.addEventListener('load', safeUpdate);
  document.addEventListener('visibilitychange', () => { if (!document.hidden) safeUpdate(); });
  window.addEventListener('pageshow', (e) => { if (e.persisted) safeUpdate(); });
  window.addEventListener('orientationchange', () => setTimeout(safeUpdate, 0), {passive:true});
  window.addEventListener('scroll', () => { requestAnimationFrame(safeUpdate); }, {passive:true});
  canvas.addEventListener('contextlost', (e) => { e.preventDefault(); });
  canvas.addEventListener('contextrestored', safeUpdate);

  requestAnimationFrame(safeUpdate);
})();
</script>
</body>
</html>
